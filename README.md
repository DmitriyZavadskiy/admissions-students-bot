# Design-Doc: Чат-бот / RAG-система  

## 1. Контекст проекта  

### 1.1 Бизнес-задача  
- Проблема: абитуриенты и их родители часто не могут быстро найти точную информацию о поступлении (программы, сроки, документы, требования, конкурс, общежитие) в длинных PDF и на страницах сайта. По этой причине часто  возникают повторяющиеся вопросы, (которые соответсвенно дают нагрузку на поддержку)
- Почему чат-бот / RAG-система: нужные знания уже есть в официальных источниках (PDF, страницы сайта, FAQ), но их трудно найти быстро собрать в один понятный ответ. RAG позволяет 1. найти актуальные фрагменты в базе знаний и 2. сгенерировать понятный ответ на русском языке, подкрепив его ссылками на источники  
- Критерии успеха: бот даёт понятные ответы на типовые вопросы и всегда прикладывает источники, уменьшается доля простых вопросов на которые вполне в состоянии ответить боту нежели человеку с поддержки. Повышается удовлетворённость пользователей качеством и ясностью ответов

### 1.2 Целевая аудитория и пользователи  
- Пользователи: абитуриенты и их родители. *дополнительно* - сотрудники приёмной комиссии для разгрузки от типовых вопросов  
- Сценарии использования: текстовый чат. *идеальный сценарий* - telegram-бот со всем функционалом 
- Нагрузка: *на этапе MVP ожидаются десятки–сотни диалогов в день в период приёмной кампании, пиковые часы - вечером и в дни дедлайнов подачи документов*  

### 1.3 Ограничения и допущения  
- Доменное ограничение: бот отвечает только по теме “поступление в университет” (сроки, документы, требования, программы, направления, общежитие, стипендии, контакты).  
- Ограничение по источникам: используются только официальные и открытые материалы (PDF/страницы сайта/FAQ).  
- Поведение при отсутствии ответа: если в базе знаний нет нужной информации, бот сообщает об этом и предлагает ссылку на официальный источник и контакты. 

## 2. Архитектура решения  

### 2.1 Общая схема  
- чат интерфейс - API - retrieval по базе знаний - LLM - пост обработка - ответ пользователю
- база знаний хранит документы/чанки + метаданные и векторный индекс. при каждом запросе пользователя backend создает эмбеддинг запроса, делает поиск top k чанков, формирует контекст, отправляет в LLM по промпт шаблону и затем форматирует ответ и добавляет ссылки
- промпт шаблон хранится в репозитории в отдельном файле  

### 2.2 Хранилище знаний / документооборот  
- Источники знаний: Правила приёма PDF, FAQ, страницы программ или направлений, сроки и этапы кампании, список документов и требования, контакты  
- Предобработка: извлечение текста из PDF/HTML, очистка мусор, дубли шапок и тд, нормализация списков, разбиение на смысловые чанки  
- Обновление данных: *на MVP - ручное обновление при выходе новой версии страниц -> далее - скрипт, который по списку URL и папке PDF пересобирает чанки и индекс*  

### 2.3 Retrieval + Generation  
- Retrieval: *FAISS или Qdrant как сервис + embedding-модель для русского текста, поиск top-k с метрикой cosine similarity и порогом релевантности threshold*  
- Generation: *LLM  облачная + промпт-шаблон: отвечай только по контексту, не выдумывай, давай ссылки*  
- Контроль ответа: ответы со ссылками на источники, при низкой релевантности retrieval или отсутствии ответа - fallback не нашёл в источниках + контакты и ссылки  

### 2.4 Интеграции и интерфейсы  
- Интерфейсы: веб интерфейс на Gradio для MVP, опционально telegram бот  
- Протоколы: *REST API между UI и backend.* webhook для Telegram   

### 2.5 Инфраструктура и развертывание  
- Развёртывание: Docker-контейнер 
- Вычисления: *на MVP - CPU*
  

## 3. Данные и качество знаний  

### 3.1 Сбор и предобработка данных  
- Источники и форматы: PDF Правила приёма, HTML страницы сайта: FAQ, сроки, документы, контакты, программы/направления  
- Шаги предобработки: извлечение текста из PDF/HTML, очистка и нормализация текста, разбиение на смысловые чанки. обработка списков/таблиц из PDF и устранение артефактов такие как переносы строк, номера страниц*  
- Метаданные: к каждому чанку добавляются ссылка на источник, название документа, раздел, актуальность/дата версии, тип источника правила/FAQ/программа/контакты  

### 3.2 Векторизация и индексирование  
- Embedding-модель: sentence-embedding модель для русского языка из  SentenceTransformers фиксируется название  
- Индекс: FAISS MVP или Qdrant, метрика cosine. параметры retrieval: top-k, threshold, возможно rerank  
- Обновление: пересборка индекса при обновлении документов, позже  - инкрементальное обновление  

### 3.3 Метрики качества знаний  
- Покрытие: доля ключевых сценариев (сроки, документы, требования, программы, общежитие, стипендии, контакты), которые имеют поддержку в базе знаний  
- Актуальность: наличие даты/версии источников. скорость обновления базы при изменении правил например, обновление в течение N дней после публикации
- Как находим спорные места: составляем список триггерных тем где чаще бывают расхождения и ошибки, *дополнительно: отмечаем спорные места по сигналам качества*
- Консистентность: отсутствие дублей и противоречий. ручная ревизия спорных мест.
- Спорные места: отслеживаем по триггерным темам: сроки подачи, перечень документов, квоты и льготы, общежитие условия

## 4. Модель и генерация  

### 4.1 Выбор LLM и промптинг  
- Модель: open-source LLM облачная. выбор обосновывается качеством русского языка, скоростью и требованиями к приватности 
- Промпт-шаблоны: ответь по контексту, не выдумывай, приведи ссылки и источники, используй списки, при необходимости задай уточняющий вопрос  
- Ограничения: лимит контекста, top-k чанков, максимальная длина ответа, требования по времени ответа
- требования к приватности: требования к приватности на MVP минимальные так как система работает по публичным документам университета.
  персональные данные не запрашиваем а также историю чата не храним

### 4.2 Контроль качества ответов  
- Метрики: точность соответствие источнику, полнота насколько ответ закрывает вопрос, полезность оценка пользователем 
- Ошибки: галлюцинации, неполный ответ, устаревшие сведения  
- Механизмы: fallback при отсутствии контекста запрет на домысливание вывод источников. *эвристика уверенности если similarity < threshold -> fallback  

### 4.3 Обучение/дообучение  
- На текущем этапе: fine-tuning не обязателен. упор на качество retrieval, чанкинга и промптинга.  
- Возможно использование набора вопросов для улучшения промптов retrieval или последующего дообучения. версионирование моделей и возможность rollback  

## 5. UX / пользовательский опыт  

### 5.1 Сценарии взаимодействия  
- Основные сценарии: приветствие, вопрос-> поиск по знаниям-> ответ. уточняющий вопрос при нехватке данных. многошаговый диалог для уточнений.  
- Исключительные сценарии: нет ответа fallback + ссылки/контакты, не поняли вопрос просим переформулировать, баг/ошибка сообщение “напишите чуть позднее” 


### 5.2 Диалоговая логика  
- Режим: single-turn для большинства вопросов + уточняющие вопросы  при необходимости например, уровень обучения, форма обучения  
- Контекст: хранение короткого окна истории диалога для уточнений. *Хранение истории на MVP можно сделать опциональным и обезличенным*  
- Тон/стиль: простой русский язык, короткие абзацы, списки 

### 5.3 Метрики UX  
- Время до первого ответа и среднее время ответа  
- Доля успешных диалогов   
- Сбор фидбэка: короткая оценка полезности. логирование ответов и выбранных источников для улучшения качества 

## 6. Безопасность, соответствие и этика  
- Персональные данные: на MVP не реализуем маскирование ПДн, предполагаем что пользователь не вводит персональные данные. также в интерфейсе предупреждаем не отправлять паспорт, телефон, адрес и любые другие ЧД которые могут идентифицировать пользователя 
- Приватность и источники: база знаний формируется из официальных открытых документов. ответы содержат ссылки на источники для проверки и снижения риска дезинформации  
- Анти-галлюцинации и репутационные риски: бот не должен выдумывать факты. при отсутствии информации - честный ответ и перенаправление на официальные контакты  
- Прозрачность и этика: пользователь информируется, что общается с ботом  

## 7. План внедрения и эксплуатации  

### 7.1 Этапы проекта  
- Фаза 0: согласование домена/датасета, подготовка источников, дизайн-док  
- Фаза 1: MVP - парсинг/чанкинг, векторная база, retrieval + генерация, простой интерфейс, базовый набор тестовых вопросов  
- Фаза 2: расширение датасета, улучшение retrieval порог/топ-k/rerank, улучшение UX и метрик, отчёт по качеству  

### 7.2 Поддержка и эксплуатация  
- Кто отвечает: разработчик проекта  
- Мониторинг: логирование ошибок, базовые метрики latency, доля fallback  
- Обновление знаний: ручное обновление документов и пересборка индекса

## 8. Риски и допущения  
- Риск: вопросы, что делаем: отказ отвечать вне домена и перенаправление на официальные источники 
- Риск: грубость, что делаем: нейтральный ответ и отказ от грубых ответов  
- Риск: prompt injection и плюс дополнительно попытка заставить игнорировать правила, что делаем: инструкция отвечать только по контексту
- Риск: запросы, связанные с чем-то незаконным или сильно отдаленным от функционала: отказ отвечать на такие темы и возвращение к теме поступления

## 9. Бюджет и ресурсы  
- Человеческие ресурсы:  
  - 1 разработчик 
- Технологические ресурсы:  
  - CPU для MVP 
- Примерные затраты:  
  - минимальные при локальном запуске. при облачной LLM - стоимость запросов 
- ROI оценки:  
  - снижение нагрузки на сотрудников поддержки по типовым вопросам, ускорение получения ответов, рост удовлетворённости абитуриентов  

## 10. Приложения  
-  
-   
- заполнится при дополнительном внесении правок в проект и использовании тех или иных ресурсов пока за основной документ возьмем 'ПОПАКТУС'
- 


## FAQ по запуску 
-
- активируем окружение: source .venv/bin/activate
- **парсит исходники PDF из data/raw/pdfs и страницы из urls.txt, чистит текст и сохраняет документы в documents.json**
- python -m scripts parse_dcs
- **берёт documents.json, режет тексты на чанки фиксированной длины и сохраняет в chunks.json**
- python -m scripts chunks
- **берёт chunks.json, считает эмбеддинги и загружает чанки в Qdrant в коллекцию admissions_chunks**
- python -m scripts indexes_for_Qadr
- **делает несколько тестовых запросов в Qdrant и печатает топ найденных фрагментов**
- python -m scripts test_search
- **прогоняет вопросы из gold_qa.json, проверяет попал ли ожидаемый документ в топ, выводит метрики попадание в топ 1 и попадание в топ k**
- python -m scripts retrieval
- **чат с моделью**
- python -m scripts rag

- В этом проекте ожидается Qwen 2.5 7B Instruct файлы:
- `models/qwen2.5-7b-instruct-q4_k_m-00001-of-00002.gguf`
- `models/qwen2.5-7b-instruct-q4_k_m-00002-of-00002.gguf`